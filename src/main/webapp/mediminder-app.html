<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="pzn-scanner/pzn-scanner.html">

<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/polymer/polymer.html">

<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-icons/iron-icons.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-ajax/iron-ajax.html">

<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-fab/paper-fab.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-dialog/paper-dialog.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-button/paper-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-input/paper-input.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-toast/paper-toast.html">

<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-header/app-header.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/app-layout/app-toolbar/app-toolbar.html">

<dom-module id="mediminder-app">
  <template>

    <style>
      app-header {
        background-color: #00897B;
        color: #fff;
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      paper-fab {
        position: fixed;
        right: 25px;
        bottom: 30px;          
      }
    </style>

    <app-drawer-layout>

      <app-drawer>
        <app-toolbar>Aktuelle Medikamente</app-toolbar>
      </app-drawer>

      <app-header-layout>

        <app-header reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>Medi Minder - Keine Medikamente vergessen!</div>
          </app-toolbar>
        </app-header>

        <!-- <pzn-scanner></pzn-scanner>  -->

      </app-header-layout>

    </app-drawer-layout>
    
    <!-- TODO: Replace with: http://spacee.xyz/polymer-components/paper-fab-menu/demo.html  -->
    <paper-fab icon="add" on-click="openPznEnterDialog"></paper-fab>
    
    <paper-dialog id="pznEnterDialog">
    	<paper-input id="pznNumber" always-float-label label="PZN Nummer"></paper-input>
    	<div class="buttons">
	    	<paper-button dialog-confirm on-click="processPZNNumber">Suchen</paper-button>
	    </div>
    	<iron-ajax
    		id="ArnzneiMobilAjax"
		    auto
		    url="[[arnzeiMobilODataPath]]"
		    params=""
		    handle-as="json"
		    on-response="onArnzneiMobilAjaxResponse"
		    on-error="onArnzneiMobilAjaxError"
		    debounce-duration="300"></iron-ajax>
    </paper-dialog>
    
    <paper-dialog id="showArticle">
    	<paper-dialog-scrollable>
    	<h1>[[article.ProduktDetails.Bezeichnung]]</h1>
    	<template is="dom-repeat" items="{{article.ProduktDetails.Produkt_TextDetails.results}}">
	        <h2>{{index}} {{item.TextTypDetails.Bezeichnung}}</h2>
	        <p>{{item.TexteDetails.Text_Data}}</p>
	    </template>
	    </paper-dialog-scrollable>
    	<div class="buttons">
    		<paper-button abort on-click="">Abbrechen</paper-button>
	    	<paper-button dialog-confirm on-click="addArticlesToReminders">Zu Medikamentenerinnerung hinzuf√ºgen</paper-button>
	    </div>
    </paper-dialog>
    
    <paper-toast id="toast"></paper-toast>

  </template>

  <script>
    Polymer({
      is: 'mediminder-app',
      properties: {
    	  arnzeiMobilODataPath: String,
    	  article: {
			type: Object
          }
      },
      openPznEnterDialog : function (e) {
		this.$.pznEnterDialog.open();
		this.$.pznNumber.focus();
      },
      processPZNNumber : function (e) {
        let pznNumber = parseInt(this.$.pznNumber.value);
        if(pznNumber) {
		    console.log("Processing: "+pznNumber);
		    this.arnzeiMobilODataPath = "ArzneiMobil.svc/Artikels("+pznNumber+")?$expand=ProduktDetails,ProduktDetails/Produkt_TextDetails,ProduktDetails/Produkt_TextDetails/TexteDetails,ProduktDetails/Produkt_TextDetails/TextTypDetails";
        }
		this.$.pznEnterDialog.close();
      },
      onArnzneiMobilAjaxResponse : function (event) {
		if(!event.detail.loading && event.detail && event.detail.response && event.detail.response.d) {
		    this.$.pznNumber.value = null;
		    this.article = event.detail.response.d;
		    this.$.showArticle.open();
	    }
      },
      onArnzneiMobilAjaxError : function (response) {
          this.$.toast.text = "PZN Nummer: "+this.$.pznNumber.value+" nicht gefunden.";
          this.$.toast.open();
		  console.log(response);
      }
    });
  </script>

</dom-module>